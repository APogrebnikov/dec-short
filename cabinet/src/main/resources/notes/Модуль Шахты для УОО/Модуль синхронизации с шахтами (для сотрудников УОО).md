# Модуль синхронизации с шахтами (для сотрудников УОО)
#work/АСУ ИКИТ#

## Алгоритм автоматической синхронизации:

### Получение данных
1) Планировщик с понедельника по субботу в 5 утра выполняет синхронизацию для ИКИТ (очн. + заочн.)
2) Синхронизация по идентификатору института и форме обучения
    1) (НЕ СДЕЛАНО) Удаление и создание таблицы curriculum_line перед началом синхронизации
    2) Получение всех групп АСУ ИКИТ, обучающихся в текущем семестре с предметами за всё время. 
    Модуль sync_mine 
    3) По группе ищем предметы в системе Шахты и отсеиваем все предметы, у которых семестр выше, чем 
    текущий у группы
    4) Сопоставление дисциплин. Проходимся по всем дисциплинам АСУ ИКИТ и сравниваем с дисциплинами 
    из системы Шахты.
        1) Сопоставляются дисциплины по названию, курсу и семестру. Если дисциплина нашлась, то
        переходим к пункту 2.5
        2) Если дисциплина не нашлась, то необходимо искать сопоставление в таблице link_curriculum_line.
        Если сопоставление не нашлось, то создаем его с пустыми значениями системы шахты (префикс _mine)
        Если сопоставление нашлось, то переходим к шагу 2.5
    5) Сравнение дисциплин. Сравниваем дисциплины из нашей системы и из системы Шахты по необходимым
    параметрам (НЕОБХОДИМО ОПРЕДЕЛИТЬ). 
        1) Если дисциплины одинаковы, то считается дисциплины идентичны и не создаем никаких запросов.
        2) Если дисциплины различны, то необходимо создать сущность в таблице curriculum_line. 
        Заполнить все поля из объекта дисциплины системы Шахты, а также заполнить поля с префиксом
        _cabinet с информацией о дисциплине из АСУ ИКИТ.
    6) Все дисциплины из Шахт, которые не удалось сопоставить, добавляем в curriculum_line, но
    без заполнения полей с префиксом _cabinet – это может обозначать следующее:
        1) Дисциплины не сопоставились
        2) Новая дисциплина
3) Ручное сопоставление. Ручное сопоставление необходимо для тех дисциплин, которые поменяли
своё название              
    
1) Получить все группы из текущего семестра
2) Получение списка предметов

2.1) Из АСУ ИКИТ необходимы следующие параметры
	(ds – dic_subject, lgs – link_group_semester, s – subject)
	
	название предмета – ds.subjectname
	курс – lgs.course
	семестр – lgs.semesternumber
	код предмета – s.subjectcode
	форма контроля – s.is_exam, s.is_pass, s.is_courseproject, s.is_coursework, s.is_practic, type (для диф. зачета)
	часы лекции – s.hourselecture
	часы лабораторные – s.hourslabor
	часы практики – s.hourspractic
	часы аудиторные – s.hoursaudcount
	часы всего – s.hourscount
	флаг факультативной дисциплины – s.is_facultative
	флаг практики – s.practictype
	(?) тип практики – не думаю, что стоит нагружать запрос 

2.2) Из АИС Деканат необходимы следующие параметры:
	(пстр – ПланыСтроки, пчасы – ПланыЧасы, пчасыс – ПланыЧасыСессии, плпр – ПланыПрактики)
	
	название предмета – пстр.Дисциплина
	курс – пчасы.курс
	семестр – пчасы.семестр
	код предмета – пстр.ДисциплинаКод

	ф.к. (экзамен)
```
	case when coalesce(плпр.Экзамен,0) = 1 then 1
		when coalesce(пчасыс.Экзамен, пчасы.Экзамен) = 1 then 1
	else 0 end
```
	
	ф.к. (зачет)
```
case when ПлПр.Код is not null and (ПлПр.Зачёт = 1 or ПлПр.ЗачётСОценкой = 1) then 1
     when ПЧасыС.Зачет = 1 or ПЧасыС.ЗачетСОценкой = 1 or ПЧасы.Зачет = 1 or ПЧасы.ЗачетСОценкой = 1 then 1 
else 0 end
```

	ф.к. (кп)
```
case when coalesce(ПлПр.КурсовойПроект, 0) = 1 then 1
     when ПЧасыС.КурсовойПроект = 1 or ПЧасы.КурсовойПроект = 1 then 1 
else 0 end
```

	ф.к. (кр)
```
	case when coalesce(ПлПр.КурсоваяРабота, 0) = 1 then 1
     when ПЧасыС.КурсоваяРабота = 1 or ПЧасы.КурсоваяРабота = 1 then 1 
	else 0 end
```

	ф.к. (тип предмета, например диф. зачет)
```
	case when coalesce(ПлПр.ЗачётСОценкой, 0) = 1 then 1
     when ПЧасы.ЗачетСОценкой = 1 or ПЧасыС.ЗачетСОценкой = 1 then 1 
	else 0 end
```

	часы лекции – coalesce(ПЧасыС.Лекции, ПЧасы.Лекций, 0)
	часы практики – coalesce(ПЧасыС.Практики, ПЧасы.Практик, 0)
 	часы лабораторные – coalesce(ПЧасыС.Лабораторные, ПЧасы.Лабораторных, 0)
	часы сам. работы – coalesce(ПЧасыС.СамРабота, ПЧасы.СамРабота, 0)
	часы экзамен – coalesce(ПЧасыС.ЧасовНаЭкзамены, ПЧасы.ЧасовНаЭкзамены, 0)
	
	флаг факультативной дисциплины – Пстр.Факультатив
	флаг практики – case when ПлПр.Код is not null then 1 else 0 end
	код кафедры – пстр.КодКафедры

### Сопоставление дисцплин
1) Отсеиваем дисциплины. С ними не будут производится никакие действия дальше.
1.1) В АИС Деканат отсеиваем все дисциплины, которые идут позже текущего семестра
1.2) В АСУ ИКИТ отсеиваем все дисциплины, где s.sync_mine = 0 
2) Сопоставление дисциплин. Изначально пытаемся найти дисциплину АСУ ИКИТ в дисциплинах АИС Деканат по названию дисциплины и курсу + специальная логика для семестра
2.1) Логика для семестра
```
пчасы.семестр = lgs.semesternumber or пчасы.семестр = lgs.semesternumber % 2 = 1 ? 1 : 2
```
2.2) В планах одна дисциплина бывает на курс, в этом случае часы разделяются по семестрам (подключается таблица ПЧасыс)
Чтобы её подключить, мы добавляем следующее сравнение:
```
ПЧасыС.ВидСессии = lgs.semesternumber % 2 = 1 ? 2 : 3 
```
3) Если не удалось найти дисциплину, то пытаемся найти строку в таблице mine.link_curriculum_line (таблица предназначена для сопоставления дисциплин у нас и в шахтах)
3.1) Искать будем по критериям groupname, course, semesternumber, subjectname 
3.2) Если строку нашли, то получаем course_mine, semester_mine, subjectname_mine и пробуем снова найти сопоставления
4) Если дисциплина не нашлась, то создаем запрос с указанием группы, курса, семестра и предмета и создаем запись в таблице mine.link_curriculum_line. Позже сотрудники УОО или программисты смогут заполнить поля course_mine, semester_mine, subjectname_mine для сопоставления дисциплин
5) После обработки всех дисциплин АСУ ИКИТ и дисциплин Шахт. Все дисциплины АСУ ИКИТ буду либо сопоставлены, либо занесены в mine.link_curriculum_line. Дисциплины из Шахт необходимо добавить в таблицу mine.curriculum_line со всеми полями дисциплины + заполнить groupname

### Сравнение дисциплин
1) Сравниваются сопоставленные дисциплины по всем дополнительным параметрам, которые не используются при сопоставлении. 
2) Если все параметры одинаковые, то ничего не делаем.
3) Если хотя бы один параметр отличается, то добавляем в таблицу mine.curriculum_line все данные по дисциплине из АИС Деканат, а также добавляем 4 поля: groupname, course_cabinet, course_semester, course_subjectname

### Обработка несопоставленных дисциплин АСУ ИКИТ
В идеале таких дисциплин вообще не должно быть, поэтому будем разработан интерфейс, где будет доступен список всех сопоставлений.

Таблица mine.link_curriculum_line, которая содержит в себе следующие поля:
группа | курс АСУ ИКИТ | семестр АСУ ИКИТ | предмет АСУ ИКИТ | курс АИС Деканат | семестр АИС Деканат | предмет АИС Деканат

Первые 4 поля обязательные и они будут заполняться нашей системой.

Для поиска дисциплины из АИС Деканат. Будет сделан запрос к таблице mine.curriculum_line по названию группы. Сотруднику УОО необходимо будет выбрать одну из дисциплин.
После выбора будут произведены следующие действия:
1) Будет заполнена найденная запись в таблице mine.link_curriculum_line (course_mine, semester_mine, subjectname_mine)
2) Если параметры дисциплин в нашей системе и параметры из таблицы mine.curriculum_line одинаковы, то удаляем запись из mine.curriculum_line
3) Если параметры различаются, то необходимо заполнить запись mine.curriculum_line следующими параметрами (course_cabinet, semester_cabinet, subjectname_cabinet) для последующей обработки

![](%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%20%D1%81%D0%B8%D0%BD%D1%85%D1%80%D0%BE%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8%20%D1%81%20%D1%88%D0%B0%D1%85%D1%82%D0%B0%D0%BC%D0%B8%20(%D0%B4%D0%BB%D1%8F%20%D1%81%D0%BE%D1%82%D1%80%D1%83%D0%B4%D0%BD%D0%B8%D0%BA%D0%BE%D0%B2%20%D0%A3%D0%9E%D0%9E)/%D0%9E%D1%82%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F%20%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D1%8F%20%D0%A8%D0%B0%D1%85%D1%82%D1%8B-%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%20%D1%88%D0%B0%D1%85%D1%82%D1%8B%20-_%20%D0%A3%D1%87%D0%B5%D0%B1%D0%BD%D1%8B%D0%B8%CC%86%20%D0%BF%D0%BB%D0%B0%D0%BD%20-_%20%D0%A1%D0%BE%D0%BF%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20(1).jpg)
Рис 1

На рисунке выше показан страница с сопоставлением учебного плана. Изначально должна быть проставлена галочка “Только несопоставленные”. Чтобы работать только с первыми проблемными дисциплинами. 
Несопоставленные являются те дисциплины, у которых нет информации по дисциплине из ШАХТЫ. Чтобы сопоставить дисциплину, необходимо выбрать строку и нажать на неё правой кнопкой -> сопоставить дисциплину.
Откроется диалоговое окно, пример которого представлен на рисунке 2.

![](%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%20%D1%81%D0%B8%D0%BD%D1%85%D1%80%D0%BE%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8%20%D1%81%20%D1%88%D0%B0%D1%85%D1%82%D0%B0%D0%BC%D0%B8%20(%D0%B4%D0%BB%D1%8F%20%D1%81%D0%BE%D1%82%D1%80%D1%83%D0%B4%D0%BD%D0%B8%D0%BA%D0%BE%D0%B2%20%D0%A3%D0%9E%D0%9E)/%D0%9E%D1%82%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F%20%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D1%8F%20%D0%A8%D0%B0%D1%85%D1%82%D1%8B-%D0%92%D1%8B%D0%B1%D0%BE%D1%80%20%D0%B4%D0%B8%D1%81%D1%86%D0%B8%D0%BF%D0%BB%D0%B8%D0%BD%D1%8B%20%D0%B4%D0%BB%D1%8F%20%D1%81%D0%BE%D0%BF%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F.jpg)
Рис. 2

В открытом диалоговом окне откроется диалоговое окно, где будет произведен поиск по дисциплин из ШАХТЫ, у которых нет информации по предметам из АСУ ИКИТ. Должен быть предзаполнен фильтры группы без возможности дальнейшего редактирования. Необходимо найти нужную дисциплину и нажать кнопку “Сопоставить”, по каждой из дисциплин можно посмотреть дополнительную информацию.
В момент сопоставления необходимо также сравнить две дисциплины. Если они идентичны, то необходимо удалить сопоставленную дисциплины ШАХТЫ из списка.


### Обработка различий по дисциплинам
Большинство параметров можно сопоставить без каких-либо сторонних процессов, но есть ряд полей, которые нужно как-то обработать, такие как: форма контроля, название дисциплины.

НА ПОДУМАТЬ: Что делать с такими дисциплинами? Нужен бизнес-процесс!

Демонстрация сравнения дисциплин из АСУ ИКИТ и ШАХТЫ представлена на рисунке 3.

![](%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%20%D1%81%D0%B8%D0%BD%D1%85%D1%80%D0%BE%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8%20%D1%81%20%D1%88%D0%B0%D1%85%D1%82%D0%B0%D0%BC%D0%B8%20(%D0%B4%D0%BB%D1%8F%20%D1%81%D0%BE%D1%82%D1%80%D1%83%D0%B4%D0%BD%D0%B8%D0%BA%D0%BE%D0%B2%20%D0%A3%D0%9E%D0%9E)/%D0%9E%D1%82%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F%20%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D1%8F%20%D0%A8%D0%B0%D1%85%D1%82%D1%8B-%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%20%D1%88%D0%B0%D1%85%D1%82%D1%8B%20-_%20%D0%A3%D1%87%D0%B5%D0%B1%D0%BD%D1%8B%D0%B8%CC%86%20%D0%BF%D0%BB%D0%B0%D0%BD%20-_%20%D0%A1%D1%80%D0%B0%D0%B2%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5.jpg)
Рис 3

Красный цвет показывает, что подобной дисциплины нет в нашей системе, либо у них различаются основные параметры и их невозможно было сопоставить. Для данной дисциплины доступны два функционала: 
создать новую дисциплину; переотправить в модуль сопоставления.

Желтый цвет показывает, что дисциплины сопоставлены, но у них отличаются некоторые из параметров. Возможные действия: сопоставить автоматически (сопоставляется часть определенных параметров (НЕОБХОДИМО ОБГОВОРИТЬ)), сопоставить вручную. Ручное сопоставление параметров представлено на рисунке 4.

TODO
Рис. 4

На рисунке выше представлена таблица, состоящая из 4 колонок: 
1) Название параметра;
2) Значение из АИС ДЕКАНАТ;
3) Значение из АСУ ИКИТ.
4) Действие. С кнопкой сопоставить. Кнопка доступна для тех параметров, у которых значения различаются.

## Диаграмма взаимодействия

![](%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%20%D1%81%D0%B8%D0%BD%D1%85%D1%80%D0%BE%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8%20%D1%81%20%D1%88%D0%B0%D1%85%D1%82%D0%B0%D0%BC%D0%B8%20(%D0%B4%D0%BB%D1%8F%20%D1%81%D0%BE%D1%82%D1%80%D1%83%D0%B4%D0%BD%D0%B8%D0%BA%D0%BE%D0%B2%20%D0%A3%D0%9E%D0%9E)/%D0%94%D0%B8%D0%B0%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0%20%D0%B2%D0%B7%D0%B0%D0%B8%D0%BC%D0%BE%D0%B4%D0%B5%D0%B8%CC%86%D1%81%D1%82%D0%B2%D0%B8%D1%8F.jpg)




